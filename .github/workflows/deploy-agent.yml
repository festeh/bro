name: Deploy Voice Agent

on:
  push:
    branches: [master]
    paths:
      - 'agent/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'livekit.yaml'
  workflow_dispatch:

env:
  DEPLOY_PATH: /opt/bro

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Deploy code to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.venv' \
            --exclude='app/' \
            --exclude='wear/' \
            --exclude='ai/frontend/node_modules' \
            --exclude='recordings/' \
            -e ssh \
            ./ root@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy environment file
        run: |
          cat > .env << ENVEOF
          LIVEKIT_URL=ws://localhost:7880
          LIVEKIT_API_KEY=${{ secrets.BRO_LIVEKIT_API_KEY }}
          LIVEKIT_API_SECRET=${{ secrets.BRO_LIVEKIT_API_SECRET }}
          DEEPGRAM_API_KEY=${{ secrets.DEEPGRAM_API_KEY }}
          ELEVEN_API_KEY=${{ secrets.ELEVEN_API_KEY }}
          ELEVENLABS_API_KEY=${{ secrets.ELEVEN_API_KEY }}
          KIMI_API_KEY=${{ secrets.KIMI_API_KEY }}
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_TOKEN }}
          GROQ_API_KEY=${{ secrets.GROQ_TOKEN }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}
          GOOGLE_AI_TOKEN=${{ secrets.GOOGLE_AI_TOKEN }}
          BASIDIAN_URL=${{ secrets.BASIDIAN_URL }}
          PYTHONPATH=/opt/bro
          ENVEOF
          scp .env root@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/.env
          rm .env

      - name: Render LiveKit config
        run: |
          export LIVEKIT_API_KEY="${{ secrets.BRO_LIVEKIT_API_KEY }}"
          export LIVEKIT_API_SECRET="${{ secrets.BRO_LIVEKIT_API_SECRET }}"
          envsubst '${LIVEKIT_API_KEY} ${LIVEKIT_API_SECRET}' < livekit.yaml > livekit-rendered.yaml
          scp livekit-rendered.yaml root@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/livekit.yaml
          rm livekit-rendered.yaml

      - name: Install dependencies and restart services
        run: |
          ssh root@${{ secrets.HOST }} << 'EOF'
          cd /opt/bro
          export PATH="/root/.local/bin:$PATH"
          uv sync --no-dev
          PYTHONPATH=/opt/bro uv run python agent/voice_agent.py download-files
          systemctl restart bro-livekit
          systemctl restart bro-agent
          sleep 3
          systemctl is-active bro-livekit
          systemctl is-active bro-agent
          EOF
